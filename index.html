<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agente de Gastos por Voz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 600px; margin: auto; }
    input, textarea, select, button { width: 100%; margin: 0.5em 0; padding: 0.7em; font-size: 1em; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>üé§ Registrar Gasto con Voz + IA</h2>

  <button onclick="startDictation()">üéôÔ∏è Dictar gasto</button>
  <textarea id="rawInput" rows="3" placeholder="Texto dictado..." readonly></textarea>

  <h3>üß† Interpretar gasto con IA</h3>
  <label>Modelo:
    <select id="modelo">
      <option value="gpt-4o">GPT‚Äë4o</option>
      <option value="gpt-3.5-turbo">GPT‚Äë3.5</option>
    </select>
  </label>
  <label>Tu clave API de OpenAI:
    <input id="apiKey" type="password" placeholder="sk-..." onchange="saveApiKey()">
  </label>
  <button onclick="interpretarConIA()">üß† Interpretar con OpenAI</button>

  <h3>üìã Datos extra√≠dos (puedes editar):</h3>
  <input id="concepto" placeholder="Concepto">
  <input id="valor" placeholder="Valor" type="number">
  <input id="medio" placeholder="Medio de pago">
  <select id="tipo">
    <option value="D√©bito">D√©bito</option>
    <option value="Cr√©dito">Cr√©dito</option>
  </select>
  <input id="presupuesto" placeholder="Presupuesto">
  <textarea id="notas" placeholder="Notas adicionales"></textarea>

  <h3>üìé Adjuntar comprobante (imagen o PDF):</h3>
  <input type="file" id="archivo" accept="image/*,.pdf">

  <button onclick="enviarFormulario()">üöÄ Enviar a Google Sheets</button>
  <div id="resultado"></div>

  <script>
    const webhook = "https://script.google.com/macros/s/AKfycbzZUaHQCfeVUla-pyyNzp0iGdcNTJS81qaKX6SKqOL3CKPa5T5d_sAUfHDUoFwtmO9U/exec";

    window.onload = () => {
      const storedKey = localStorage.getItem("openai_api_key");
      if (storedKey) document.getElementById("apiKey").value = storedKey;
    }

    function saveApiKey() {
      localStorage.setItem("openai_api_key", document.getElementById("apiKey").value);
    }

    function startDictation() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'es-ES';
      recognition.start();
      recognition.onresult = function(event) {
        const text = event.results[0][0].transcript;
        document.getElementById("rawInput").value = text;
      }
    }

    async function interpretarConIA() {
      const input = document.getElementById("rawInput").value;
      const apiKey = document.getElementById("apiKey").value;
      const modelo = document.getElementById("modelo").value;
      if (!apiKey || !input) return alert("Falta texto o clave API");

      const prompt = `Devu√©lveme √∫nicamente un objeto JSON v√°lido (sin explicaciones) con las siguientes claves en espa√±ol: concepto, valor (n√∫mero), medio_pago, debito_credito, presupuesto, notas. Ejemplo: {\n  \"concepto\": \"Netflix\",\n  \"valor\": 53000,\n  \"medio_pago\": \"Tarjeta Visa\",\n  \"debito_credito\": \"D√©bito\",\n  \"presupuesto\": \"Servicios\",\n  \"notas\": \"Pago mensual\"\n}. Texto: \"${input}\"`;

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: modelo,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.2
          })
        });

        if (response.status === 429) {
          alert("‚ö†Ô∏è Has alcanzado el l√≠mite de velocidad de la API de OpenAI. Espera un momento y vuelve a intentar.");
          return;
        }

        const data = await response.json();

        if (data.error && data.error.code === "insufficient_quota") {
          alert("‚ùå No tienes cr√©dito suficiente en tu cuenta de OpenAI. Revisa tu panel: https://platform.openai.com/account/usage y tu facturaci√≥n.");
          return;
        }

        const content = data.choices[0].message.content;
        console.log("Respuesta bruta de OpenAI:", content);
        const obj = JSON.parse(content);
        document.getElementById("concepto").value = obj.concepto || "";
        document.getElementById("valor").value = obj.valor || "";
        document.getElementById("medio").value = obj.medio_pago || "";
        document.getElementById("tipo").value = obj.debito_credito || "D√©bito";
        document.getElementById("presupuesto").value = obj.presupuesto || "";
        document.getElementById("notas").value = obj.notas || "";
      } catch (e) {
        alert("‚ùå No se pudo interpretar correctamente la respuesta de IA. Revisa consola (F12).\n\n" + e.message);
        console.log("Error capturado:", e);
      }
    }

    async function enviarFormulario() {
      const fd = new FormData();
      const archivo = document.getElementById("archivo").files[0];
      const data = {
        concepto: document.getElementById("concepto").value,
        valor: parseFloat(document.getElementById("valor").value),
        medio_pago: document.getElementById("medio").value,
        debito_credito: document.getElementById("tipo").value,
        presupuesto: document.getElementById("presupuesto").value,
        notas: document.getElementById("notas").value
      };

      if (archivo) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          data.foto_base64 = e.target.result;
          data.foto_nombre = archivo.name;
          await enviarData(data);
        }
        reader.readAsDataURL(archivo);
      } else {
        await enviarData(data);
      }
    }

    async function enviarData(data) {
      const res = await fetch(webhook, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      });
      const resultado = await res.json();
      document.getElementById("resultado").innerText = resultado.status === 'success'
        ? "‚úÖ Gasto registrado con √©xito"
        : "‚ùå Error: " + resultado.message;
    }
  </script>
</body>
</html>
