<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agente de Gastos por Voz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 600px; margin: auto; }
    input, textarea, select, button { width: 100%; margin: 0.5em 0; padding: 0.7em; font-size: 1em; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>üé§ Registrar Gasto con Voz + IA</h2>

  <button onclick="startDictation()">üéôÔ∏è Dictar gasto</button>
  <textarea id="rawInput" rows="3" placeholder="Texto dictado..." spellcheck="true"></textarea>

  <h3>üß† Interpretar gasto</h3>
  <button onclick="interpretarLocalmente()">üß† Interpretar sin IA</button>
  <button onclick="interpretarConOpenRouter()">ü§ñ Interpretar con IA (OpenRouter)</button>

  <label>API Key OpenRouter:
    <input id="openrouterKey" type="password" placeholder="pk-..." onchange="localStorage.setItem('openrouterKey', this.value)">
  </label>

  <h3>üìã Datos extra√≠dos (puedes editar):</h3>
  <input id="concepto" placeholder="Concepto">
  <input id="valor" placeholder="Valor" type="number">
  <input id="medio" placeholder="Medio de pago">
  <select id="tipo">
    <option value="D√©bito">D√©bito</option>
    <option value="Cr√©dito">Cr√©dito</option>
  </select>
  <input id="presupuesto" placeholder="Presupuesto">
  <textarea id="notas" placeholder="Notas adicionales"></textarea>

  <h3>üìé Adjuntar comprobante (imagen o PDF):</h3>
  <input type="file" id="archivo" accept="image/*,.pdf">

  <button onclick="enviarFormulario()">üöÄ Enviar a Google Sheets</button>
  <div id="resultado"></div>

  <script>
    const webhook = "https://script.google.com/macros/s/AKfycbzZUaHQCfeVUla-pyyNzp0iGdcNTJS81qaKX6SKqOL3CKPa5T5d_sAUfHDUoFwtmO9U/exec";

    window.onload = () => {
      const saved = localStorage.getItem("openrouterKey");
      if (saved) document.getElementById("openrouterKey").value = saved;
    };

    function startDictation() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'es-ES';
      recognition.start();
      recognition.onresult = function(event) {
        const text = event.results[0][0].transcript;
        document.getElementById("rawInput").value = text;
      }
    }

    function interpretarLocalmente() {
      const texto = document.getElementById("rawInput").value.toLowerCase();
      if (!texto) return alert("Dicta un gasto antes de interpretar");

      let concepto = "", valor = "", medio = "", tipo = "D√©bito", presupuesto = "", notas = texto;

      const numMatch = texto.match(/\d{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?/);
      if (numMatch) valor = numMatch[0].replace(/[.,]/g, '');

      if (texto.includes("nequi")) medio = "Nequi";
      else if (texto.includes("daviplata")) medio = "Daviplata";
      else if (texto.includes("efectivo")) medio = "Efectivo";
      else if (texto.includes("tarjeta")) medio = "Tarjeta";

      if (texto.includes("cr√©dito")) tipo = "Cr√©dito";

      if (texto.includes("hogar")) presupuesto = "Hogar";
      else if (texto.includes("factura")) presupuesto = "Facturas";

      const verbos = ["pagu√©", "cancel√©", "compr√©", "gast√©", "transfer√≠"];
      for (let verbo of verbos) {
        if (texto.includes(verbo)) {
          const inicio = texto.indexOf(verbo) + verbo.length;
          const resto = texto.slice(inicio).trim();
          const fin = resto.indexOf("con") !== -1 ? resto.indexOf("con") : resto.length;
          concepto = resto.slice(0, fin).trim();
          break;
        }
      }

      if (!concepto) {
        const palabras = texto.split(" ");
        concepto = palabras.find(p => p.length > 4) || "";
      }

      document.getElementById("concepto").value = concepto;
      document.getElementById("valor").value = valor;
      document.getElementById("medio").value = medio;
      document.getElementById("tipo").value = tipo;
      document.getElementById("presupuesto").value = presupuesto;
      document.getElementById("notas").value = notas;
    }

    async function interpretarConOpenRouter() {
      const apiKey = document.getElementById("openrouterKey").value;
      const input = document.getElementById("rawInput").value;
      if (!apiKey || !input) return alert("Falta texto o API Key");

      const prompt = `Extrae estos campos en JSON v√°lido desde el siguiente texto: concepto, valor, medio_pago, debito_credito, presupuesto, notas. Texto: "${input}"`;

      const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "openai/gpt-3.5-turbo",
          messages: [
            { role: "user", content: prompt }
          ]
        })
      });

      const data = await response.json();
      try {
        const result = JSON.parse(data.choices[0].message.content);
        document.getElementById("concepto").value = result.concepto || "";
        document.getElementById("valor").value = result.valor || "";
        document.getElementById("medio").value = result.medio_pago || "";
        document.getElementById("tipo").value = result.debito_credito || "D√©bito";
        document.getElementById("presupuesto").value = result.presupuesto || "";
        document.getElementById("notas").value = result.notas || "";
      } catch (e) {
        alert("No se pudo interpretar la respuesta de OpenRouter");
        console.error(data);
      }
    }

    async function enviarFormulario() {
      const archivo = document.getElementById("archivo").files[0];
      const data = {
        concepto: document.getElementById("concepto").value,
        valor: parseFloat(document.getElementById("valor").value),
        medio_pago: document.getElementById("medio").value,
        debito_credito: document.getElementById("tipo").value,
        presupuesto: document.getElementById("presupuesto").value,
        notas: document.getElementById("notas").value
      };

      if (archivo) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          data.foto_base64 = e.target.result;
          data.foto_nombre = archivo.name;
          await enviarData(data);
        }
        reader.readAsDataURL(archivo);
      } else {
        await enviarData(data);
      }
    }

    async function enviarData(data) {
      const res = await fetch(webhook, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      });
      const resultado = await res.json();
      document.getElementById("resultado").innerText = resultado.status === 'success'
        ? "‚úÖ Gasto registrado con √©xito"
        : "‚ùå Error: " + resultado.message;
    }
  </script>
</body>
</html>
